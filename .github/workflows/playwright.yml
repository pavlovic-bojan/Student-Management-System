name: ğŸ­ Playwright Tests (API + E2E)

on:
  push:
    branches: [main, master]
    paths:
      - 'tests/e2e/**'
      - '.github/workflows/playwright.yml'
  workflow_dispatch:

jobs:
  test:
    name: API & E2E Tests
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: â˜• Setup Java for Allure
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ­ Install Playwright browsers (E2E)
        run: npx playwright install --with-deps chromium
        working-directory: tests/e2e

      - name: ğŸ§ª Run API tests
        env:
          API_BASE_URL: ${{ secrets.BACKEND_URL || 'https://student-management-system-backend-gwy8.onrender.com' }}
          TEST_USER_EMAIL: ${{ secrets.TEST_USER_EMAIL || 'platform-admin@sms.edu' }}
          TEST_USER_PASSWORD: ${{ secrets.TEST_USER_PASSWORD || 'seed-platform-admin-change-me' }}
        continue-on-error: true
        run: npm run test:api
        working-directory: tests/e2e

      - name: ğŸ§ª Run E2E tests
        env:
          BASE_URL: ${{ secrets.FRONTEND_URL || 'https://student-management-system-frontend-topaz.vercel.app' }}
          TEST_USER_EMAIL: ${{ secrets.TEST_USER_EMAIL || 'platform-admin@sms.edu' }}
          TEST_USER_PASSWORD: ${{ secrets.TEST_USER_PASSWORD || 'seed-platform-admin-change-me' }}
        continue-on-error: true
        run: npm run test:e2e
        working-directory: tests/e2e

      - name: ğŸ“Š Generate Allure report
        if: always()
        run: |
          if [ -d "allure-results" ] && [ "$(ls -A allure-results 2>/dev/null)" ]; then
            if ! command -v allure &> /dev/null; then
              echo "ğŸ“¦ Installing Allure CLI..."
              wget -q https://github.com/allure-framework/allure2/releases/download/2.24.1/allure-2.24.1.tgz
              tar -zxf allure-2.24.1.tgz
              sudo mv allure-2.24.1 /opt/allure
              sudo ln -sf /opt/allure/bin/allure /usr/local/bin/allure
            fi
            allure generate allure-results --clean -o allure-report
            echo "âœ… Allure report generated"
          else
            echo "âš ï¸ No allure-results, creating placeholder"
            mkdir -p allure-report
            echo '<!DOCTYPE html><html><head><title>No Test Results</title></head><body><h1>No test results</h1><p>Tests did not produce Allure results.</p></body></html>' > allure-report/index.html
          fi
        working-directory: tests/e2e

      - name: ğŸ“¤ Upload Allure report as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: tests/e2e/allure-report
          retention-days: 30

      - name: ğŸ“¦ Prepare gh-pages content (allure/ + load/ + index.html)
        if: always() && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        run: |
          mkdir -p gh-pages-content
          git fetch origin gh-pages 2>/dev/null || true
          if git rev-parse origin/gh-pages >/dev/null 2>&1; then
            git archive origin/gh-pages | tar -x -C gh-pages-content 2>/dev/null || true
          fi
          mkdir -p gh-pages-content/allure gh-pages-content/load
          cp -r tests/e2e/allure-report/* gh-pages-content/allure/
          if [ ! -f gh-pages-content/load/index.html ]; then
            echo '<!DOCTYPE html><html><body><h1>No load test results yet</h1><p>Run the Performance workflow.</p></body></html>' > gh-pages-content/load/index.html
          fi
          cp .github/pages-index.html gh-pages-content/index.html

      - name: ğŸš€ Deploy to GitHub Pages (gh-pages)
        if: always() && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./gh-pages-content
          publish_branch: gh-pages
          force_orphan: true

      - name: ğŸ“¢ Report URL
        if: always() && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        run: |
          echo "ğŸ“Š Test reports deployed to GitHub Pages"
          echo "ğŸ”— https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
