name: ğŸš€ Backend Deploy to Render

# Trigger on push to main branch (backend changes only)
on:
  push:
    branches: [main, master]
    paths:
      - 'backend/**'
      - '.github/workflows/backend-deploy-render.yml'
  workflow_dispatch: # Allow manual trigger

jobs:
  test-and-migrate:
    name: Test & Migrate Database
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout code
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      # 2. Setup Node.js
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 3. Install dependencies
      - name: ğŸ“¦ Install dependencies
        run: |
          cd backend
          npm install

      # 4. Generate Prisma Client
      - name: ğŸ”„ Generate Prisma Client
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          cd backend
          npm run prisma:generate

      # 5. Run backend tests
      - name: ğŸ§ª Run backend tests
        env:
          NODE_ENV: test
          SKIP_AUTH_FOR_TESTS: '1'
          DATABASE_URL: ${{ secrets.TEST_DATABASE_URL }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          SESSION_SECRET: ${{ secrets.SESSION_SECRET }}
        run: |
          cd backend
          npm test

      # 6. Run Prisma migrations on PRODUCTION database
      - name: ğŸ”„ Run database migrations
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          cd backend
          npx prisma migrate deploy
          echo "âœ… Migrations applied successfully!"

      # 7. Trigger Render Deploy via Deploy Hook
      - name: ğŸš€ Trigger Render Deploy
        run: |
          curl -fsS -X POST "${{ secrets.RENDER_DEPLOY_HOOK }}"
          echo "âœ… Render deploy triggered!"

      # 8. Wait for Render to start deploying (cold start can be 1â€“2 min on free tier)
      - name: â³ Wait for deployment (90 seconds)
        run: sleep 90

      # 9. Health check (retry up to 8 times, 15s apart; curl timeout 10s per attempt)
      - name: ğŸ¥ Health check
        run: |
          for i in 1 2 3 4 5 6 7 8; do
            if curl -fsS --connect-timeout 10 --max-time 15 "${{ secrets.BACKEND_URL }}/api/health"; then
              echo "âœ… Backend is healthy!"
              exit 0
            fi
            echo "Waiting for backend... (attempt $i/8)"
            sleep 15
          done
          echo "âŒ Health check failed!"
          exit 1

      # 10. Notify on success
      - name: âœ… Deployment successful
        if: success()
        run: |
          echo "âœ… Backend deployed successfully!"
          echo "ğŸ”— URL: ${{ secrets.BACKEND_URL }}"
          echo "ğŸ“‹ API base: ${{ secrets.BACKEND_URL }}/api"
          echo "ğŸ“„ OpenAPI spec: see backend/openapi.yaml in repo"
